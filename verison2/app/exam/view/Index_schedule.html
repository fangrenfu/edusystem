<layout name="all@index/layout" />
<script type="text/javascript">
    var type='{$type.type}';
    var typename='{$type.typename}';
    $(function () {
        var flag = $('#flag');
        flag.combobox({
            url: '{$ROOT}/all/option/testbatch?only=0&year={$YEARTERM.year}&term={$YEARTERM.term}&type='+type,
            valueField: 'flag',
            textField: 'name'
        });

        var teacherschool = $('#teacherschool');
        teacherschool.combobox({
            url: '{$ROOT}/all/option/school?only=0',
            valueField: 'school',
            textField: 'name'
        });
        //设置默认学院，非管理部门为本学院
        if ('{$USERINFO.manage}' != '1')
            teacherschool.combobox('select', '{$USERINFO.school}');
        var courseschool = $('#courseschool');
        courseschool.combobox({
            url: '{$ROOT}/all/option/school?only=0',
            valueField: 'school',
            textField: 'name'
        });
        var studentschool = $('#studentschool');
        studentschool.combobox({
            url: '{$ROOT}/all/option/school?only=0',
            valueField: 'school',
            textField: 'name'
        });
        $('#dg').datagrid({
            title: '',
            idField: 'id',
            striped: 'true',
            pagination: 'true',
            singleSelect:'true',
            rownumbers: 'true',
            pageSize:20,
            url: '{$ROOT}/exam/teacher/courselist',
            queryParams: {
                year:$("#year").val(),
                term:$('#term').val(),
                type:type
            },
            toolbar: '#toolbar',
            pageList: [20,40,60,100],
            columns: [[
                {field: 'testtime', title: '考试时间', width: 150, align: 'center',rowspan:2},
                {field: 'courseno', title: '课号', width: 70, align: 'center',rowspan:2},
                {field: 'coursename', title: '课名', width: 120, align: 'center',rowspan:2},
                {field: 'attendents', title: '人数', width: 35, align: 'center',rowspan:2},
                {field: 'schoolname', title: '开课学院', width: 80, align: 'center',rowspan:2},
                {field: 'studentschoolname', title: '学生学院', width: 85, align: 'center',rowspan:2},
                {field: 'classes', title: '班级', width: 120, align: 'center',rowspan:2},
                {title: '考场1',colspan:4},
                {title: '考场2',colspan:4},
                {field: 'rem', title: '备注*', width: 120, align: 'center',rowspan:2,editor:{type:'validatebox',options:{validType:'maxLength[50]'}}}
            ],[
                {field: 'roomno1', title: '房间', width: 70, align: 'center'},
                {field: 'teachername1', title: '监考1', width: 45, align: 'center'},
                {field: 'teachername2', title: '监考2', width: 45, align: 'center'},
                {field: 'teachername3', title: '监考3', width: 45, align: 'center'},
                {field: 'roomno2', title: '房间', width: 70, align: 'center'},
                {field: 'teachername4', title: '监考1', width: 45, align: 'center'},
                {field: 'teachername5', title: '监考2', width: 45, align: 'center'},
                {field: 'teachername6', title: '监考3', width: 45, align: 'center'}
            ]
            ],
            //标题行右键菜单
            onHeaderContextMenu: function (e, field) {
                e.preventDefault();
                if (!cmenu_obj.cmenu)//没有的话创建一个
                    $('#dg').datagrid('createColumnMenu', cmenu_obj);
                cmenu_obj.cmenu.menu('show', {
                    left: e.pageX,
                    top: e.pageY
                });
            },
            //数据行上右键菜单
            onRowContextMenu:function(e,rowindex,row){
                e.preventDefault();
                var tt=$('#dg');
                tt.datagrid('selectRow',rowindex);
                $('#menu').menu('show',{
                    left: e.pageX,
                    top: e.pageY
                });
            },
            //点击单元格时候的事件
            onClickCell:function(index, field){
                var tt= $('#dg');
                tt.datagrid('startEditing',{index:index,field:field});
                current_datagrid=tt;
            }
        });
        function checkCourseSchool(rows){
            var count=rows.length;
            for(var i=0;i<count;i++){ //教师所在学院不是本学院的，且登录账户不在职能部门不允许修改。
                if(rows[i].school!='{$USERINFO.school}'&&'{$USERINFO.manage}'!='1'){
                    $.messager.alert('错误','你无法修改其他学院的课程信息（'+rows[i].coursename+'）！','error');
                    $("#cancel").click();
                    return false;
                }
            }
            return true;
        }
        function buildDataArray(rows){
            var updateRow=[];
            var length=rows.length;
            for (var i = 0; i < length; i++) {
                var updateObj = {}; //插入的单元格
                updateObj.id=rows[i].id;
                updateObj.courseno=rows[i].courseno;
                updateObj.rem = rows[i].rem;
                updateRow.push(updateObj);
            }
            return updateRow;
        }
        $("#save,#menu_save").click(function(){
            var tt=$('#dg');
            tt.datagrid('endEditing');
            if(tt.datagrid('editIndex')!=undefined) return;
            //获取更改的数据行内容
            var rows=tt.datagrid('getRows');
            rows=tt.datagrid('getChanges','updated');
            if(!checkCourseSchool(rows)) return;
            var count=0;
            var effectRow ={};
            if(rows.length>0){
                count+=rows.length;
                effectRow["updated"]=$.toJSON(buildDataArray(rows));
            }
            if(count<=0){ //如果没有任何更新，就退出
                $.messager.alert('提示','没有数据需要保存！','info');
                return;
            }
            $.post('{$ROOT}/exam/teacher/updaterem',effectRow,function(result){
                if (result.status==1){
                    tt.datagrid('acceptChanges');
                    tt.datagrid('reload');
                    $.messager.show({	// show error message
                        title: '成功',
                        msg: result.info
                    });
                } else {
                    $.messager.alert('错误',result.info,'error');
                }
            },'json');
        });
        $("#search").click(function () {
            var tt = $('#dg');
            tt.datagrid('loadData', {total: 0, rows: []});
            tt.datagrid('load', {
                year:$("#year").val(),
                term:$('#term').val(),
                type:type,
                flag:flag.combobox('getValue'),
                school:courseschool.combobox('getValue'),
                studentschool:studentschool.combobox('getValue')
            });
        });
        $('#menu_export,#export').click(function(){
            var year= encodeURI($('#year').val());
            var term= encodeURI($('#term').val());
            var flag=encodeURI($('#flag').combobox('getValue'));
            var school=encodeURI($('#courseschool').combobox('getValue'));
            var studentschool=encodeURI($('#studentschool').combobox('getValue'));
            var teachername=encodeURI($('#teachername').val());
            $.fileDownload("{$ROOT}/exam/teacher/export?year="+year+"&term="+term+"&flag="+flag+"&school="+school+"&studentschool="+studentschool+"&teachername="+teachername+'&type='+type, {
                preparingMessageHtml: "正在导出数据，请稍候...<br/>请勿做其它操作！.",
                dialogOptions: {modal: true, title: '提示'},
                failCallback: function (html, url) {
                    $.messager.alert('错误',html,'error');
                }
            });
        });
    });
    function print(item){
        var url='/exam/index/roomtimetable?roomno='+item+'&year='+$("#year").val()+"&term="+$("#term").val();
        window.open('{$ROOT}'+url);
    }
</script>
<div class="container">
    <div id="menu" class="easyui-menu" style="width:120px;">
        <div id='menu_export' data-options="iconCls:'icon icon-excel'">导出</div>
        <div class="menu-sep"></div>
        <div id='menu_save' data-options="iconCls:'icon icon-save'">保存备注</div>
    </div>
    <div id="toolbar">
        <label for="year">学年：</label><input id="year" class="easyui-validatebox" size="4" value="{$YEARTERM.year}"/>
        <label for="term">学期：</label><input id="term" class="easyui-validatebox" size="2" value="{$YEARTERM.term}"/>
        <label for="courseschool">开课学院：</label><input id="courseschool" size="18" />
        <label for="studentschool">学生学院：</label><input id="studentschool" size="18" />
        <label for="flag">场次：</label><input id="flag" size="24">
        <label for="teachername">监考姓名：</label><input id="teachername" class="easyui-validatebox" size="5" value="%"/>
        <a href="#" class="easyui-linkbutton"  data-options="iconCls:'icon icon-search',plain:'true'" id="search">检索</a> |
        <a href="#" class="easyui-linkbutton"  data-options="iconCls:'icon icon-save',plain:'true'" id="save">保存备注</a>
        <a href="#" class="easyui-linkbutton"  data-options="iconCls:'icon icon-excel',plain:'true'" id="export">导出</a>
    </div>
        <table id="dg"></table>
    <div class="space"></div>
    <div class="information" style="clear:both">
        <ol>说明：

        </ol>
    </div>
</div>